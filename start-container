#!/usr/bin/env bash

# Make sure correct user is set
if [ "$SUPERVISOR_PHP_USER" != "root" ] && [ "$SUPERVISOR_PHP_USER" != "sail" ]; then
    echo "You should set SUPERVISOR_PHP_USER to either 'sail' or 'root'."
    exit 1
fi

# Make sure the laravel project is installed
if [ ! -f "/var/www/html/artisan" ]; then
    echo "Laravel artisan not found! Make sure project is installed."
    exit 1
fi

# Check for configuration directories and files
config_dir="/var/www/config"
db_dir="${config_dir}/database"
db_file="${db_dir}/database.sqlite"
log_dir="${config_dir}/logs"
log_file="${log_dir}/laravel.log"
queue_log_file="${log_dir}/queue.log"
reverb_log_file="${log_dir}/reverb.log"
swoole_log_file="${log_dir}/swoole_http.log"

# Create config directories
if [ ! -d "${config_dir}" ]; then
    echo "Missing config directory, please make sure you've linked it in volumes to continue. It should link to '/var/www/config' in the container."
    exit 1
fi
if [ ! -d "${db_dir}" ]; then
    echo "Creating database directory..."
    mkdir "${db_dir}"
fi
if [ ! -d "${log_dir}" ]; then
    echo "Creating log directory..."
    mkdir "${log_dir}"
fi

# Create database file
if [ ! -f "${db_file}" ]; then
    echo "Missing database file, creating now..."
    touch "${db_file}"
fi

# Create log files
if [ ! -f "${log_file}" ]; then
    echo "Missing laravel log file, creating now..."
    touch "${log_file}"
fi
if [ ! -f "${queue_log_file}" ]; then
    echo "Missing queue log file, creating now..."
    touch "${queue_log_file}"
fi
if [ ! -f "${reverb_log_file}" ]; then
    echo "Missing reverb log file, creating now..."
    touch "${reverb_log_file}"
fi
if [ ! -f "${swoole_log_file}" ]; then
    echo "Missing swoole log file, creating now..."
    touch "${swoole_log_file}"
fi

# Link the log files to the laravel `storage/logs` directory
ln -sf "${log_file}" storage/logs/laravel.log
ln -sf "${queue_log_file}" storage/logs/queue.log
ln -sf "${reverb_log_file}" storage/logs/reverb.log
ln -sf "${swoole_log_file}" storage/logs/swoole_http.log

# Link the database file to the laravel `database` directory
ln -sf "${db_file}" "database/database.sqlite"

# Update permissions
sudo chown -R sail:$WWWGROUP /var/www/html
sudo chmod -R 775 /var/www/html/storage
sudo chmod -R 775 /var/www/html/database/database.sqlite

# If vendor directory is missing, install composer dependencies
if [ ! -d "vendor" ]; then
    echo "Installing composer dependencies..."
    composer install --no-dev --no-interaction --no-progress
fi

# If node_modules directory is missing, install npm dependencies
if [ ! -d "node_modules" ]; then
    echo "Installing npm dependencies..."
    npm install
    npm run build
fi

if [ -z "$APP_KEY" ]; then
    echo "App key not set. Generating one..."
    php artisan key:generate
fi

php artisan migrate --force
php artisan optimize

if [ ! -z "$WWWUSER" ]; then
    usermod -u $WWWUSER sail
fi

if [ ! -d /.composer ]; then
    mkdir /.composer
fi

chmod -R ugo+rw /.composer

if [ $# -gt 0 ]; then
    if [ "$SUPERVISOR_PHP_USER" = "root" ]; then
        exec "$@"
    else
        exec gosu $WWWUSER "$@"
    fi
else
    exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
fi
